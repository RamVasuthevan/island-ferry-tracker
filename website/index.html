<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hello World</title>
    <script>
        // Function to display the current time in EST
        function displayCurrentTimeEST() {
            const options = { timeZone: 'America/New_York', hour: '2-digit', minute: '2-digit', second: '2-digit' };
            document.getElementById('currentTime').innerText = new Date().toLocaleTimeString('en-US', options);
        }

        // Function to list the schedule for today and initialize ferry route dropdown
        async function listTodaySchedule() {
            const response = await fetch('data/schedule.json');
            const schedules = await response.json();
            const today = new Date().toISOString().split('T')[0];
            const routeSelect = document.getElementById('ferryRoute');

            schedules.forEach(schedule => {
                if (new Date(schedule.start) <= new Date(today) && (schedule.end === null || new Date(schedule.end) >= new Date(today))) {
                    Object.keys(schedule.locations).forEach(location => {
                        Object.keys(schedule.locations[location]).forEach(direction => {
                            const routeOption = `${location} - ${direction}`;
                            const option = document.createElement('option');
                            option.value = JSON.stringify({location, direction});
                            option.innerText = routeOption;
                            routeSelect.appendChild(option);
                        });
                    });
                }
            });
        }

        // Show next two ferry times based on selected route
        async function showNextFerryTimes(selectedRoute) {
            const {location, direction} = JSON.parse(selectedRoute);
            const response = await fetch('data/schedule.json');
            const schedules = await response.json();
            const today = new Date().toISOString().split('T')[0];
            const nextTimesContainer = document.getElementById('nextFerryTimes');
            nextTimesContainer.innerHTML = ''; // Clear previous selection

            schedules.forEach(schedule => {
                if (new Date(schedule.start) <= new Date(today) && (schedule.end === null || new Date(schedule.end) >= new Date(today))) {
                    const times = schedule.locations[location][direction];
                    const nextTimes = getNextTwoTimes(times);
                    if (nextTimes.length > 0) {
                        nextTimesContainer.innerHTML += `<p>Next times for ${location} - ${direction}: ${nextTimes.join(', ')}</p>`;
                    }
                }
            });
        }

        // Helper function to get the next two times
        function getNextTwoTimes(times) {
            const currentTime = new Date();
            const currentHours = currentTime.getHours();
            const currentMinutes = currentTime.getMinutes();
            let nextTwoTimes = [];

            for (let time of times) {
                const [hours, minutes] = time.split(':').map(num => parseInt(num, 10));
                if (hours > currentHours || (hours === currentHours && minutes > currentMinutes)) {
                    nextTwoTimes.push(convertToAmPm(time));
                    if (nextTwoTimes.length === 2) break;
                }
            }

            return nextTwoTimes;
        }

        // Helper function to convert time to AM/PM format
        function convertToAmPm(time) {
            const [hours, minutes] = time.split(':');
            const hoursInt = parseInt(hours, 10);
            if (hoursInt === 0) {
                return `12:${minutes} AM`; // Midnight edge case
            } else if (hoursInt < 12) {
                return `${time} AM`;
            } else if (hoursInt === 12) {
                return `${time} PM`; // Noon edge case
            } else {
                return `${hoursInt - 12}:${minutes} PM`;
            }
        }

        // Initialize functions on window load
        window.onload = function() {
            displayCurrentTimeEST();
            listTodaySchedule();
            setInterval(displayCurrentTimeEST, 1000); // Update the time every second
        };

        // Add event listener to ferry route select dropdown
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('ferryRoute').addEventListener('change', (event) => {
                showNextFerryTimes(event.target.value);
            });
        });
    </script>
</head>
<body>
    <h1>Hello, World!</h1>
    <p>Current Time (EST): <span id="currentTime"></span></p>
    <select id="ferryRoute">
        <option value="">Select Ferry Route</option>
    </select>
    <div id="nextFerryTimes"></div>
</body>
</html>
