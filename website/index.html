<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hello World</title>
    <style>
        #nextTimesTable, #ferryTimes {
            margin-top: 20px;
            padding: 10px;
            border-radius: 5px;
        }
        #nextTimesTable {
            background-color: #f0f0f0;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            text-align: left;
            padding: 8px;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #4CAF50;
            color: white;
        }
    </style>
    <script>
        function displayCurrentTimeEST() {
            const options = { timeZone: 'America/New_York', hour: '2-digit', minute: '2-digit', second: '2-digit' };
            document.getElementById('currentTime').innerText = new Date().toLocaleTimeString('en-US', options);
        }

        async function listTodaySchedule() {
            const response = await fetch('data/schedule.json');
            const schedules = await response.json();
            const today = new Date().toISOString().split('T')[0];
            const routeSelect = document.getElementById('ferryRoute');

            schedules.forEach(schedule => {
                if (new Date(schedule.start) <= new Date(today) && (schedule.end === null || new Date(schedule.end) >= new Date(today))) {
                    Object.keys(schedule.locations).forEach(location => {
                        Object.keys(schedule.locations[location]).forEach(direction => {
                            let routeOption;
                            if (direction === "Departs City") {
                                routeOption = `City to ${location}`;
                            } else if (direction === "Departs Island") {
                                routeOption = `${location} to City`;
                            }
                            const option = document.createElement('option');
                            option.value = JSON.stringify({location, direction});
                            option.innerText = routeOption;
                            routeSelect.appendChild(option);
                        });
                    });
                }
            });
        }

        async function showNextFerryTimes(selectedRoute) {
            const {location, direction} = JSON.parse(selectedRoute);
            let routeOption;
            if (direction === "Departs City") {
                routeOption = `City to ${location}`;
            } else if (direction === "Departs Island") {
                routeOption = `${location} to City`;
            }

            const response = await fetch('data/schedule.json');
            const schedules = await response.json();
            const today = new Date().toISOString().split('T')[0];
            const nextTimesTable = document.getElementById('nextTimesTable');
            nextTimesTable.innerHTML = ''; // Clear previous selection
            const ferryTimes = document.getElementById('ferryTimes');
            ferryTimes.innerHTML = '';

            let remainingTimes = schedules.map(schedule => schedule.locations[location][direction]).flat();
            remainingTimes = remainingTimes.filter(time => isLaterThanCurrentTime(time));

            if (remainingTimes.length > 0) {
                let nextTwoTimes = remainingTimes.slice(0, 2);
                let nextTimesTableHTML = `<table><tr><th colspan="2">Next Departures</th></tr>`;
                nextTwoTimes.forEach(time => {
                    nextTimesTableHTML += `<tr><td colspan="2">${convertToAmPm(time)}</td></tr>`;
                });
                nextTimesTableHTML += `</table>`;
                nextTimesTable.innerHTML = nextTimesTableHTML;

                let remainingTimesTableHTML = `<table><tr><th>Remaining Times Today</th></tr>`;
                remainingTimes.forEach(time => {
                    remainingTimesTableHTML += `<tr><td>${convertToAmPm(time)}</td></tr>`;
                });
                remainingTimesTableHTML += `</table>`;
                ferryTimes.innerHTML = remainingTimesTableHTML;
            } else {
                ferryTimes.innerHTML = `<p>No more departures for ${routeOption} today.</p>`;
            }
        }

        function isLaterThanCurrentTime(time) {
            const [hours, minutes] = time.split(':').map(Number);
            const currentTime = new Date();
            return hours > currentTime.getHours() || (hours === currentTime.getHours() && minutes > currentTime.getMinutes());
        }

        function convertToAmPm(time) {
            const [hours, minutes] = time.split(':');
            const hoursInt = parseInt(hours, 10);
            return hoursInt === 0 ? `12:${minutes} AM` :
                   hoursInt < 12 ? `${hours}:${minutes} AM` :
                   hoursInt === 12 ? `${hours}:${minutes} PM` :
                                     `${hoursInt - 12}:${minutes} PM`;
        }

        window.onload = function() {
            displayCurrentTimeEST();
            listTodaySchedule();
            setInterval(displayCurrentTimeEST, 1000);
        };

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('ferryRoute').addEventListener('change', (event) => {
                showNextFerryTimes(event.target.value);
            });
        });
    </script>
</head>
<body>
    <h1>Hello, World!</h1>
    <p>Current Time (EST): <span id="currentTime"></span></p>
    <select id="ferryRoute">
        <option value="">Select Ferry Route</option>
    </select>
    <div id="nextTimesTable"></div>
    <div id="ferryTimes"></div>
</body>
</html>
